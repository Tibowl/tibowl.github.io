<!doctype html>
<html>
    <head>
        <title>Flat is Justice! - ship lock map maker</title>
        <meta name="theme-color" content="#082E6B"/>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:title" content="Flat is Justice - ship lock map maker">
        <meta name="twitter:description" content="Make ship lock maps">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
        <script src="https://unpkg.com/blob-util/dist/blob-util.min.js"></script>

        <style type="text/css">
            input[type="number"] {
                width:75px;
            }
            canvas {
                margin: 5px;
            }
        </style>
    </head>
    <body>
        <a href="."><b>Flat is Justice - Home</b></a><br>
        <br>
        main.js section: <br><textarea id="code">
            e.prototype._getBGTexture = function(t) {
                switch (t) {
                    case 451:
                        return o.SALLY_STRATEGYMAP.getTexture(23);
                    case 452:
                        return o.SALLY_STRATEGYMAP.getTexture(24);
                    case 453:
                        return r.SALLY_STRATEGYMAP_S.getTexture(7);
                    default:
                        return PIXI.Texture.EMPTY
                }
            },
            e.prototype._createAreaAnimation = function(t) {
                switch (this._cleanArea(), t) {
                    case 451:
                        return this._createArea(1, 70, o.SALLY_STRATEGYMAP.getTexture(0)),
                        this._createArea(42, 21, o.SALLY_STRATEGYMAP.getTexture(1)),
                        void this._createArea(30, 165, o.SALLY_STRATEGYMAP.getTexture(2));
                    case 452:
                        return this._createArea(53, 116, o.SALLY_STRATEGYMAP.getTexture(3)),
                        void this._createArea(147, 71, o.SALLY_STRATEGYMAP.getTexture(4));
                    case 453:
                        return this._createArea(126, 130, r.SALLY_STRATEGYMAP_S.getTexture(0)),
                        void this._createArea(105, 6, r.SALLY_STRATEGYMAP_S.getTexture(1));
                    default:
                        return
                }
            },
            e.prototype._createArrowAnimation = function(t) {
                switch (this._cleanArrow(), t) {
                    case 451:
                        return this._createArrow(37, 120, o.SALLY_STRATEGYMAP.getTexture(5), o.SALLY_STRATEGYMAP.getTexture(6)),
                        this._createArrow(97, 72, o.SALLY_STRATEGYMAP.getTexture(7), o.SALLY_STRATEGYMAP.getTexture(8)),
                        void this._createArrow(85, 158, o.SALLY_STRATEGYMAP.getTexture(9), o.SALLY_STRATEGYMAP.getTexture(10));
                    case 452:
                        return this._createArrow(10, 105, o.SALLY_STRATEGYMAP.getTexture(11), o.SALLY_STRATEGYMAP.getTexture(12)),
                        void this._createArrow(130, 115, o.SALLY_STRATEGYMAP.getTexture(13), o.SALLY_STRATEGYMAP.getTexture(14));
                    case 453:
                        return void this._createArrow(24, 54, r.SALLY_STRATEGYMAP_S.getTexture(2), r.SALLY_STRATEGYMAP_S.getTexture(3));
                    default:
                        return
                }
            },
            e.prototype._createArea = function(t, e, i) {
                var n = new a(i);
                n.x = t,
                n.y = e,
                this._area_layer.addChild(n)
            },
            e.prototype._cleanArea = function() {
                for (var t = 0, e = this._area_layer.children; t < e.length; t++) {
                    e[t].dispose()
                }
                this._area_layer.removeChildren()
            },
            e.prototype._createArrow = function(t, e, i, n) {
                var o = new _(i, n);
                o.x = t,
                o.y = e,
                this._arrow_layer.addChild(o)
            },
            e.prototype._cleanArrow = function() {
                for (var t = 0, e = this._arrow_layer.children; t < e.length; t++) {
                    e[t].dispose()
                }
                this._arrow_layer.removeChildren()
            },
            e.prototype._createAirBase = function(t) {
                this._base.removeChildren()
            },
            e.prototype._createPlate = function(t) {
                var e = this;
                this._plate.removeChildren();
                var i = function(t, i, n) {
                    var o = new PIXI.Sprite(t);
                    o.position.set(i, n),
                    e._plate.addChild(o)
                };
                switch (t) {
                    case 451:
                        return void i(o.SALLY_STRATEGYMAP.getTexture(17), 108, 143);
                    case 452:
                        return void i(o.SALLY_STRATEGYMAP.getTexture(18), 132, 178);
                    case 453:
                        return void i(r.SALLY_STRATEGYMAP_S.getTexture(4), 122, 160);
                    default:
                        return
                }
            },
            e.prototype._createLabelAnimation = function(t) {
                switch (this._cleanLabel(), t) {
                    case 451:
                        return void this._createLabel(47, 80, o.SALLY_STRATEGYMAP.getTexture(19), o.SALLY_STRATEGYMAP.getTexture(20));
                    case 452:
                        return void this._createLabel(27, 91, o.SALLY_STRATEGYMAP.getTexture(21), o.SALLY_STRATEGYMAP.getTexture(22));
                    case 453:
                        return void this._createLabel(19, 118, r.SALLY_STRATEGYMAP_S.getTexture(5), r.SALLY_STRATEGYMAP_S.getTexture(6));
                    default:
                        return
                }
            },
            e.prototype._createLabel = function(t, e, i, n) {
                var o = new l(i, n);
                o.x = t,
                o.y = e,
                this._label_layer.addChild(o)
            },
            e.prototype._cleanLabel = function() {
                for (var t = 0, e = this._label_layer.children; t < e.length; t++) {
                    e[t].dispose()
                }
                this._label_layer.removeChildren()
            },
            e.prototype._createMiniTextAnimation = function(t) {
                switch (this._cleanMiniText(), t) {
                    case 452:
                    case 453:
                        return void this._createLabel(192, 281, o.SALLY_STRATEGYMAP.getTexture(28), o.SALLY_STRATEGYMAP.getTexture(29));
                    default:
                        return
                }
            },
            e.prototype._createMiniText = function(t, e, i, n) {
                var o = new u(i, n);
                o.x = t,
                o.y = e,
                this._mini_text_layer.addChild(o)
            },
            e.prototype._cleanMiniText = function() {
                for (var t = 0, e = this._mini_text_layer.children; t < e.length; t++) {
                    e[t].dispose()
                }
                this._mini_text_layer.removeChildren()
            },
            e.prototype._getTitleTexture = function(t) {
                switch (t) {
                    case 451:
                        return o.SALLY_STRATEGYMAP.getTexture(25);
                    case 452:
                        return o.SALLY_STRATEGYMAP.getTexture(26);
                    case 453:
                        return r.SALLY_STRATEGYMAP_S.getTexture(8);
                    default:
                        return PIXI.Texture.EMPTY
                }
            },
</textarea><br>
        Map: <input type="text" id="mapid" value="45" onchange="update()"> <br>
        <br>
        <button name="Update" onclick="update()">Force update</button><br><br>
        <a id="download">Download</a><br>
        <b>Edges map</b><br>
        <script type="text/javascript">
            var show = {}, locData, canvas, loader, map;
            let SERVER = "203.104.209.71";
 
            window.PIXI.utils.skipHello();
            let app = new PIXI.Application({width: 280, height: 338, transparent: true, forceCanvas: true, preserveDrawingBuffer:true});
            document.body.appendChild(canvas = app.view);
            
            let xOff = 0, yOff = 0, drawPhase = "";

            let getTexture = (loc, id) => {
                let texid = loc.toLowerCase() + '_' + id;
                if(PIXI.TextureCache[texid])
                    return texid;
                switch(drawPhase) {
                    case 'area':
                        return "https://i.imgur.com/QXkeLzo.png";
                    case 'plate':
                        return 'https://i.imgur.com/wU3MZmG.png';
                    case 'title':
                        return 'https://i.imgur.com/s2hHrKl.png';
                    case 'arrow':
                    case 'label':
                        return 'https://i.imgur.com/ESZl1ar.png';
                    case 'minitext':
                        return 'https://i.imgur.com/GJrSTKS.png'
                    case 'map':
                        return 'https://i.imgur.com/eUMcFQV.png';
                    default:
                        return 'https://i.imgur.com/WxF5fiw.png';
                }
            };
            let _plate = {removeChildren: () => 0}
            let _createBG = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                sprite.alpha = 63/64
                bgLayer.addChild(sprite);
            };
            let _cleanArrow = () => 0;
            let _createArrow = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                arrowLayer.addChild(sprite);
            };
            let _cleanArea = () => 0;
            let _createArea = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                areaLayer.addChild(sprite);
            };
            let _createTitle = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff+Math.round(140-sprite.width/2), y+yOff);
                titleLayer.addChild(sprite);
            };
            let _cleanLabel = () => 0;
            let _createLabel = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                labelLayer.addChild(sprite);
            };
            let _cleanMiniText = () => 0;
            let i = (id, x,y) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                miscLayer.addChild(sprite);
            };
            let _createPlateIcon = (id, x, y) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                miscLayer.addChild(sprite);
            };
            let bgLayer, areaLayer, arrowLayer, titleLayer, labelLayer, miscLayer;

            function update(selectedmap = document.getElementById("mapid").value) {
                for (let i = app.stage.children.length - 1; i >= 0; i--) {  app.stage.removeChild(app.stage.children[i]); };
                app.stage.addChild(bgLayer = new PIXI.Container);
                app.stage.addChild(areaLayer = new PIXI.Container);
                app.stage.addChild(arrowLayer = new PIXI.Container);
                app.stage.addChild(titleLayer = new PIXI.Container);
                app.stage.addChild(labelLayer = new PIXI.Container);
                app.stage.addChild(miscLayer = new PIXI.Container);

                map = parseInt(selectedmap.replace('-'))
                let code = document.getElementById("code").value;

                let type = ''
                let currentCode = '\n';
                for(let line of code.split("\n")) {
                    if(line.indexOf('    },') > 0) {
                        console.log(`window.${type}=${currentCode}}`)
                        if(type != '')
                            eval(`window.${type}=${currentCode}}`)
                        type = '';
                        currentCode = '\n';
                    } else if(line.indexOf('prototype') > 0) {
                        console.log("pt", line);
                        for(let posType of ['_getBGTexture', '_getTitleTexture', '_createAreaAnimation', '_createArrowAnimation', '_createLabelAnimation', '_createPlate', '_createMiniTextAnimation'])
                            if(line.indexOf(posType) > 0)
                                type = posType;

                        currentCode = line.split(' = ')[1]+'\n';
                    } else {
                        let rep = line.replace(/\w+.([\w]+)\.getTexture\(/g, "getTexture('$1', ").replace(/this./g, '')+'\n';

                        if(type == '_createPlate')
                            rep = rep.replace(/void [a-z]/g, "_createPlateIcon");
                        if(type == '_createPlate')
                            rep = rep.replace(/return [a-z]/g, "return _createPlateIcon");
                        currentCode += rep;
                    }
                }

                loader = new PIXI.loaders.Loader;

                loader.add([
                        getPath('sally_strategymap.json'),
                        getPath('sally_strategymap_s.json'),
                       'https://i.imgur.com/wU3MZmG.png', // Unkown ship lock
                       'https://i.imgur.com/QXkeLzo.png', // !
                       'https://i.imgur.com/WxF5fiw.png', // flag
                       'https://i.imgur.com/ESZl1ar.png', // empty
                       'https://i.imgur.com/eUMcFQV.png', // map
                       'https://i.imgur.com/s2hHrKl.png', // title
                       'https://i.imgur.com/GJrSTKS.png'  // minitext
                    ]).load(function() {
                    delete document.getElementById("download").href
                    for(let i = 1; _getBGTexture(map*10+i) != PIXI.Texture.EMPTY; i++)
                        showMap(map*10+i);

                    blobUtil.canvasToBlob(canvas, 'image/png').then(function (blob) {
                        console.log(blob.size)
                        document.getElementById("download").href = blobUtil.createObjectURL(blob);
                    })
                    document.getElementById("download").addEventListener('click', function() {
                        let d = new Date();
                        this.download = `Tag lock ${map}.png`;
                    }, false);

                })
            }
            function getPath(url) {
                return `http://${SERVER}/kcs2/img/sally/${url}`
            }
            function showMap(map) {            
                console.log("Show map")
                console.log(map, _getBGTexture(map))
                xOff = 8+(map%10-1)*300;
                yOff = 8;
                app.view.width = (map%10)*300;
                drawPhase = 'map';
                _createBG(0,0,_getBGTexture(map));
                drawPhase = 'arrow';
                _createArrowAnimation(map);
                drawPhase = 'area';
                _createAreaAnimation(map);
                drawPhase = 'label';
                _createLabelAnimation(map);
                drawPhase = 'miniText';
                _createMiniTextAnimation(map);
                drawPhase = 'plate';
                _createPlate(map);
                drawPhase = 'title';
                _createTitle(0,305,_getTitleTexture(map));

                for(let dir of [[1,0,.5,0], [0,-1,1,.5], [1,0,1,.5], [0,1,.5,0]]) {
                    let text = new PIXI.Text("@FlatIsNice", secretstyle);
                    text.setTransform(xOff + app.stage.width*dir[2], app.stage.height*dir[3], 1, 1, Math.atan2(-dir[1], dir[0]));
                    text.anchor.set(.5,0);
                    text.alpha = 1/64;
                    app.stage.addChild(text);
                }
                
                let text = new PIXI.Text("@FlatIsNice", secretstyle);
                text.x = xOff + 30;
                text.y = 290;
                text.alpha = 1/32;
                app.stage.addChild(text);

                app.render();
            }
            let secretstyle = new PIXI.TextStyle({
              fontFamily: "Arial",
              fontSize: 20,
              fill: "#393",
            });

            update();
        </script>
    </body>
</html>