<!doctype html>
<html>
    <head>
        <title>Flat is Justice! - ship lock map maker</title>
        <meta name="theme-color" content="#082E6B"/>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:title" content="Flat is Justice - ship lock map maker">
        <meta name="twitter:description" content="Make ship lock maps">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
        <script src="https://unpkg.com/blob-util/dist/blob-util.min.js"></script>

        <style type="text/css">
            input[type="number"] {
                width:75px;
            }
            canvas {
                margin: 5px;
            }
        </style>
    </head>
    <body>
        <a href="."><b>Flat is Justice - Home</b></a><br>
        <br>
        main.js section: <br><textarea id="code">
            _1230113956.prototype._getBGTexture = function(_934160944) {
                switch (_934160944) {
                    case 471:
                        return _1230113952.SALLY_STRATEGYMAP.getTexture(7);
                    default:
                        return PIXI.Texture.EMPTY;
                }
            },
            _1230113956.prototype._createAreaAnimation = function(_925589753) {
                switch (this._cleanArea(), _925589753) {
                    case 471:
                    default:
                        return;
                }
            },
            _1230113956.prototype._createArrowAnimation = function(_1315473068) {
                switch (this._cleanArrow(), _1315473068) {
                    case 471:
                        return this._createArrow(0, 107, _1230113952.SALLY_STRATEGYMAP.getTexture(0), _1230113952.SALLY_STRATEGYMAP.getTexture(1)),
                        void this._createArrow(137, 144, _1230113952.SALLY_STRATEGYMAP.getTexture(2), _1230113952.SALLY_STRATEGYMAP.getTexture(3));
                    default:
                        return;
                }
            },
            _1230113956.prototype._createArea = function(_789782147, _789782148, _789782149) {
                var _789782150 = new _789782151(_789782149);
                _789782150['x'] = _789782147,
                _789782150['y'] = _789782148,
                this._area_layer.addChild(_789782150);
            },
            _1230113956.prototype._cleanArea = function() {
                for (var _2000023186 = 0, _2000023187 = this._area_layer.children; _2000023186 < _2000023187.length; _2000023186++) {
                    _2000023187[_2000023186].dispose();
                }
                this._area_layer.removeChildren();
            },
            _1230113956.prototype._createArrow = function(_1914716600, _1914716601, _1914716602, _1914716603) {
                var _1914716604 = new _1914716605(_1914716602, _1914716603);
                _1914716604['x'] = _1914716600,
                _1914716604['y'] = _1914716601,
                this._arrow_layer.addChild(_1914716604);
            },
            _1230113956.prototype._cleanArrow = function() {
                for (var _553291670 = 0, _553291671 = this._arrow_layer.children; _553291670 < _553291671.length; _553291670++) {
                    _553291671[_553291670].dispose();
                }
                this._arrow_layer.removeChildren();
            },
            _1230113956.prototype._createAirBase = function(_508782636) {
                this._base.removeChildren();
            },
            _1230113956.prototype._createPlate = function(_1682114550) {
                this._plate.removeChildren();
                switch (_1682114550) {
                    case 471:
                    default:
                        return;
                }
            },
            _1230113956.prototype._createLabelAnimation = function(_511527563) {
                switch (this._cleanLabel(), _511527563) {
                    case 471:
                        return void this._createLabel(65, 67, _1230113952.SALLY_STRATEGYMAP.getTexture(5), _1230113952.SALLY_STRATEGYMAP.getTexture(6));
                    default:
                        return;
                }
            },
            _1230113956.prototype._createLabel = function(_1988934363, _1988934364, _1988934365, _1988934366) {
                var _1988934367 = new _1988934368(_1988934365, _1988934366);
                _1988934367['x'] = _1988934363,
                _1988934367['y'] = _1988934364,
                this._label_layer.addChild(_1988934367);
            },
            _1230113956.prototype._cleanLabel = function() {
                for (var _1177686000 = 0, _1177686001 = this._label_layer.children; _1177686000 < _1177686001.length; _1177686000++) {
                    _1177686001[_1177686000].dispose();
                }
                this._label_layer.removeChildren();
            },
            _1230113956.prototype._createMiniTextAnimation = function(_804504316) {
                switch (this._cleanMiniText(), _804504316) {
                    case 471:
                        return void this._createMiniText(192, 286, _1230113952.SALLY_STRATEGYMAP.getTexture(10), _1230113952.SALLY_STRATEGYMAP.getTexture(11));
                    default:
                        return;
                }
            },
            _1230113956.prototype._createMiniText = function(_2079775989, _2079775990, _2079775991, _2079775992) {
                var _2079775993 = new _2079775994(_2079775991, _2079775992);
                _2079775993['x'] = _2079775989,
                _2079775993['y'] = _2079775990,
                this._mini_text_layer.addChild(_2079775993);
            },
            _1230113956.prototype._cleanMiniText = function() {
                for (var _1213532438 = 0, _1213532439 = this._mini_text_layer.children; _1213532438 < _1213532439.length; _1213532438++) {
                    _1213532439[_1213532438].dispose();
                }
                this._mini_text_layer.removeChildren();
            },
            _1230113956.prototype._getTitleTexture = function(_836833585) {
                switch (_836833585) {
                    case 471:
                        return _1230113952.SALLY_STRATEGYMAP.getTexture(8);
                    default:
                        return PIXI.Texture.EMPTY;
                }
            },
</textarea><br>
        Map: <input type="text" id="mapid" value="47" onchange="update()"> <br>
        <br>
        <button name="Update" onclick="update()">Force update</button><br><br>
        <a id="download">Download</a><br>
        <b>Edges map</b><br>
        <script type="text/javascript">
            var show = {}, locData, canvas, loader, map;
            let SERVER = "203.104.209.71";
 
            window.PIXI.utils.skipHello();
            let app = new PIXI.Application({width: 280, height: 338, transparent: true, forceCanvas: true, preserveDrawingBuffer:true});
            document.body.appendChild(canvas = app.view);
            
            let xOff = 0, yOff = 0, drawPhase = "";

            let getTexture = (loc, id) => {
                let texid = loc.toLowerCase() + '_' + id;
                if(PIXI.TextureCache[texid])
                    return texid;
                switch(drawPhase) {
                    case 'area':
                        return "https://i.imgur.com/QXkeLzo.png";
                    case 'plate':
                        return 'https://i.imgur.com/wU3MZmG.png';
                    case 'title':
                        return 'https://i.imgur.com/s2hHrKl.png';
                    case 'arrow':
                    case 'label':
                        return 'https://i.imgur.com/ESZl1ar.png';
                    case 'minitext':
                        return 'https://i.imgur.com/GJrSTKS.png'
                    case 'map':
                        return 'https://i.imgur.com/eUMcFQV.png';
                    default:
                        return 'https://i.imgur.com/WxF5fiw.png';
                }
            };
            let _plate = {removeChildren: () => 0}
            let _createBG = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                sprite.alpha = 63/64
                bgLayer.addChild(sprite);
            };
            let _cleanArrow = () => 0;
            let _createArrow = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                arrowLayer.addChild(sprite);
            };
            let _cleanArea = () => 0;
            let _createArea = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                areaLayer.addChild(sprite);
            };
            let _createTitle = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff+Math.round(140-sprite.width/2), y+yOff);
                titleLayer.addChild(sprite);
            };
            let _cleanLabel = () => 0;
            let _createLabel = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                labelLayer.addChild(sprite);
            };
            let _createMiniText = _createLabel
            let _cleanMiniText = () => 0;
            let i = (id, x,y) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                miscLayer.addChild(sprite);
            };
            let _createPlateIcon = (id, x, y) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                miscLayer.addChild(sprite);
            };
            let bgLayer, areaLayer, arrowLayer, titleLayer, labelLayer, miscLayer;

            function update(selectedmap = document.getElementById("mapid").value) {
                for (let i = app.stage.children.length - 1; i >= 0; i--) {  app.stage.removeChild(app.stage.children[i]); };
                app.stage.addChild(bgLayer = new PIXI.Container);
                app.stage.addChild(areaLayer = new PIXI.Container);
                app.stage.addChild(arrowLayer = new PIXI.Container);
                app.stage.addChild(titleLayer = new PIXI.Container);
                app.stage.addChild(labelLayer = new PIXI.Container);
                app.stage.addChild(miscLayer = new PIXI.Container);

                map = parseInt(selectedmap.replace('-'))
                let code = document.getElementById("code").value;

                let type = ''
                let currentCode = '\n';
                for(let line of code.split("\n")) {
                    if(line.indexOf('    },') > 0) {
                        console.log(currentCode)
                        console.log(`window.${type}=${currentCode}}`)
                        if(type != '')
                            eval(`window.${type}=${currentCode}}`)
                        type = '';
                        currentCode = '\n';
                    } else if(line.indexOf('prototype') > 0) {
                        console.log("pt", line);
                        for(let posType of ['_getBGTexture', '_getTitleTexture', '_createAreaAnimation', '_createArrowAnimation', '_createLabelAnimation', '_createPlate', '_createMiniTextAnimation'])
                            if(line.indexOf(posType) > 0)
                                type = posType;

                        currentCode = line.split(' = ')[1]+'\n';
                    } else {
                        let rep = line.replace(/\w+.([\w]+)\.getTexture\(/g, "getTexture('$1', ").replace(/this./g, '')+'\n';

                        if(type == '_createPlate')
                            rep = rep.replace(/void [a-z]/g, "_createPlateIcon");
                        if(type == '_createPlate')
                            rep = rep.replace(/return [a-z]/g, "return _createPlateIcon");
                        currentCode += rep;
                    }
                }

                loader = new PIXI.loaders.Loader;

                loader.add([
                        getPath('sally_strategymap.json'),
                        getPath('sally_strategymap_s.json'),
                       'https://i.imgur.com/wU3MZmG.png', // Unkown ship lock
                       'https://i.imgur.com/QXkeLzo.png', // !
                       'https://i.imgur.com/WxF5fiw.png', // flag
                       'https://i.imgur.com/ESZl1ar.png', // empty
                       'https://i.imgur.com/eUMcFQV.png', // map
                       'https://i.imgur.com/s2hHrKl.png', // title
                       'https://i.imgur.com/GJrSTKS.png'  // minitext
                    ]).load(function() {
                    delete document.getElementById("download").href
                    for(let i = 1; _getBGTexture(map*10+i) != PIXI.Texture.EMPTY; i++)
                        showMap(map*10+i);

                    blobUtil.canvasToBlob(canvas, 'image/png').then(function (blob) {
                        console.log(blob.size)
                        document.getElementById("download").href = blobUtil.createObjectURL(blob);
                    })
                    document.getElementById("download").addEventListener('click', function() {
                        let d = new Date();
                        this.download = `Tag lock ${map}.png`;
                    }, false);

                })
            }
            function getPath(url) {
                return `http://${SERVER}/kcs2/img/sally/${url}`
            }
            function showMap(map) {            
                console.log("Show map")
                console.log(map, _getBGTexture(map))
                xOff = 8+(map%10-1)*300;
                yOff = 8;
                app.view.width = (map%10)*300;
                drawPhase = 'map';
                _createBG(0,0,_getBGTexture(map));
                drawPhase = 'arrow';
                _createArrowAnimation(map);
                drawPhase = 'area';
                _createAreaAnimation(map);
                drawPhase = 'label';
                _createLabelAnimation(map);
                drawPhase = 'miniText';
                _createMiniTextAnimation(map);
                drawPhase = 'plate';
                _createPlate(map);
                drawPhase = 'title';
                _createTitle(0,305,_getTitleTexture(map));

                for(let dir of [[1,0,.5,0], [0,-1,1,.5], [1,0,1,.5], [0,1,.5,0]]) {
                    let text = new PIXI.Text("@FlatIsNice", secretstyle);
                    text.setTransform(xOff + app.stage.width*dir[2], app.stage.height*dir[3], 1, 1, Math.atan2(-dir[1], dir[0]));
                    text.anchor.set(.5,0);
                    text.alpha = 1/64;
                    app.stage.addChild(text);
                }
                
                let text = new PIXI.Text("@FlatIsNice", secretstyle);
                text.x = xOff + 30;
                text.y = 290;
                text.alpha = 1/32;
                app.stage.addChild(text);

                app.render();
            }
            let secretstyle = new PIXI.TextStyle({
              fontFamily: "Arial",
              fontSize: 20,
              fill: "#393",
            });

            update();
        </script>
    </body>
</html>