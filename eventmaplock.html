<!doctype html>
<html>
    <head>
        <title>Flat is Justice! - ship lock map maker</title>
        <meta name="theme-color" content="#082E6B"/>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:title" content="Flat is Justice - ship lock map maker">
        <meta name="twitter:description" content="Make ship lock maps">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
        <script src="https://unpkg.com/blob-util/dist/blob-util.min.js"></script>

        <style type="text/css">
            input[type="number"] {
                width:75px;
            }
            canvas {
                margin: 5px;
            }
        </style>
    </head>
    <body>
        <a href="."><b>Flat is Justice - Home</b></a><br>
        <br>
        main.js section: <br><textarea id="code">
            _1230114023.prototype._getBGTexture = function(_1990913776) {
                switch (_1990913776) {
                    case 481:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(34);
                    case 482:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(35);
                    case 483:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(36);
                    case 484:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(37);
                    case 485:
                        return _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(23);
                    case 486:
                        return _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(24);
                    case 487:
                        return _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(25);
                    default:
                        return PIXI.Texture.EMPTY;
                }
            },
            _1230114023.prototype._createAreaAnimation = function(_948685055) {
                switch (this._cleanArea(), _948685055) {
                    case 481:
                        return void this._createArea(86, 63, _1230114019.SALLY_STRATEGYMAP.getTexture(0));
                    case 482:
                        return this._createArea(1, 143, _1230114019.SALLY_STRATEGYMAP.getTexture(1)),
                        void this._createArea(76, 88, _1230114019.SALLY_STRATEGYMAP.getTexture(2));
                    case 483:
                        return this._createArea(23, 36, _1230114019.SALLY_STRATEGYMAP.getTexture(3)),
                        this._createArea(2, 108, _1230114019.SALLY_STRATEGYMAP.getTexture(4)),
                        void this._createArea(151, 166, _1230114019.SALLY_STRATEGYMAP.getTexture(5));
                    case 484:
                        return this._createArea(84, 58, _1230114019.SALLY_STRATEGYMAP.getTexture(6)),
                        this._createArea(60, 157, _1230114019.SALLY_STRATEGYMAP.getTexture(7)),
                        void this._createArea(127, 110, _1230114019.SALLY_STRATEGYMAP.getTexture(8));
                    case 485:
                        return this._createArea(147, 29, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(0)),
                        this._createArea(1, 109, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(1)),
                        void this._createArea(142, 141, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(2));
                    case 486:
                        return void this._createArea(121, 118, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(3));
                    case 487:
                        return void this._createArea(100, 98, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(4));
                    default:
                        return;
                }
            },
            _1230114023.prototype._createArrowAnimation = function(_2111657991) {
                switch (this._cleanArrow(), _2111657991) {
                    case 481:
                        return void this._createArrow(16, 65, _1230114019.SALLY_STRATEGYMAP.getTexture(9), _1230114019.SALLY_STRATEGYMAP.getTexture(10));
                    case 482:
                        return void this._createArrow(56, 22, _1230114019.SALLY_STRATEGYMAP.getTexture(11), _1230114019.SALLY_STRATEGYMAP.getTexture(12));
                    case 483:
                        return this._createArrow(170, 79, _1230114019.SALLY_STRATEGYMAP.getTexture(13), _1230114019.SALLY_STRATEGYMAP.getTexture(14)),
                        void this._createArrow(12, 115, _1230114019.SALLY_STRATEGYMAP.getTexture(15), _1230114019.SALLY_STRATEGYMAP.getTexture(16));
                    case 484:
                        return this._createArrow(77, 117, _1230114019.SALLY_STRATEGYMAP.getTexture(17), _1230114019.SALLY_STRATEGYMAP.getTexture(18)),
                        void this._createArrow(0, 44, _1230114019.SALLY_STRATEGYMAP.getTexture(19), _1230114019.SALLY_STRATEGYMAP.getTexture(20));
                    case 485:
                        return void this._createArrow(28, 72, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(5), _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(6));
                    case 486:
                        return void this._createArrow(9, 41, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(7), _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(8));
                    case 487:
                        return void this._createArrow(1, 6, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(9), _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(10));
                    default:
                        return;
                }
            },
            _1230114023.prototype._createArea = function(_2049632834, _2049632835, _2049632836) {
                var _2049632837 = new _2049632838(_2049632836);
                _2049632837['x'] = _2049632834,
                _2049632837['y'] = _2049632835,
                this._area_layer.addChild(_2049632837);
            },
            _1230114023.prototype._cleanArea = function() {
                for (var _2000023186 = 0, _2000023187 = this._area_layer.children; _2000023186 < _2000023187.length; _2000023186++) {
                    _2000023187[_2000023186].dispose();
                }
                this._area_layer.removeChildren();
            },
            _1230114023.prototype._createArrow = function(_1914716600, _1914716601, _1914716602, _1914716603) {
                var _1914716604 = new _1914716605(_1914716602, _1914716603);
                _1914716604['x'] = _1914716600,
                _1914716604['y'] = _1914716601,
                this._arrow_layer.addChild(_1914716604);
            },
            _1230114023.prototype._cleanArrow = function() {
                for (var _553291670 = 0, _553291671 = this._arrow_layer.children; _553291670 < _553291671.length; _553291670++) {
                    _553291671[_553291670].dispose();
                }
                this._arrow_layer.removeChildren();
            },
            _1230114023.prototype._createAirBase = function(_508782636) {
                this._base.removeChildren();
            },
            _1230114023.prototype._createPlate = function(_1682114550) {
                var _1682114551 = this;
                this._plate.removeChildren();
                var _1250343213 = function(_1250343214, _1250343215, _1250343216) {
                    var _1134213100 = new PIXI[('Sprite')](_1250343214);
                    _1134213100.position.set(_1250343215, _1250343216),
                    _1682114551._plate.addChild(_1134213100);
                };
                switch (_1682114550) {
                    case 481:
                        return void _1250343213(_1230114019.SALLY_STRATEGYMAP.getTexture(22), 149, 47);
                    case 482:
                        return void _1250343213(_1230114019.SALLY_STRATEGYMAP.getTexture(23), 149, 44);
                    case 483:
                        return void _1250343213(_1230114019.SALLY_STRATEGYMAP.getTexture(24), 115, 150);
                    case 484:
                        return void _1250343213(_1230114019.SALLY_STRATEGYMAP.getTexture(25), 43, 146);
                    case 485:
                        return void _1250343213(_1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(12), 143, 156);
                    case 486:
                        return void _1250343213(_1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(13), 118, 169);
                    case 487:
                        return _1250343213(_1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(14), 43, 53),
                        _1250343213(_1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(15), 102, 163),
                        void _1250343213(_1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(16), 112, 36);
                    default:
                        return;
                }
            },
            _1230114023.prototype._createLabelAnimation = function(_1887022779) {
                switch (this._cleanLabel(), _1887022779) {
                    case 481:
                        return void this._createLabel(49, 126, _1230114019.SALLY_STRATEGYMAP.getTexture(26), _1230114019.SALLY_STRATEGYMAP.getTexture(27));
                    case 482:
                        return void this._createLabel(27, 125, _1230114019.SALLY_STRATEGYMAP.getTexture(28), _1230114019.SALLY_STRATEGYMAP.getTexture(29));
                    case 483:
                        return void this._createLabel(19, 73, _1230114019.SALLY_STRATEGYMAP.getTexture(30), _1230114019.SALLY_STRATEGYMAP.getTexture(31));
                    case 484:
                        return void this._createLabel(6, 29, _1230114019.SALLY_STRATEGYMAP.getTexture(32), _1230114019.SALLY_STRATEGYMAP.getTexture(33));
                    case 485:
                        return void this._createLabel(51, 85, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(17), _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(18));
                    case 486:
                        return void this._createLabel(53, 117, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(19), _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(20));
                    case 487:
                        return void this._createLabel(30, 112, _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(21), _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(22));
                    default:
                        return;
                }
            },
            _1230114023.prototype._createLabel = function(_1367194, _1367195, _1367196, _1367197) {
                var _1367198 = new _1367199(_1367196, _1367197);
                _1367198['x'] = _1367194,
                _1367198['y'] = _1367195,
                this._label_layer.addChild(_1367198);
            },
            _1230114023.prototype._cleanLabel = function() {
                for (var _1177686000 = 0, _1177686001 = this._label_layer.children; _1177686000 < _1177686001.length; _1177686000++) {
                    _1177686001[_1177686000].dispose();
                }
                this._label_layer.removeChildren();
            },
            _1230114023.prototype._createMiniTextAnimation = function(_804504316) {
                switch (this._cleanMiniText(), _804504316) {
                    case 482:
                    case 483:
                    case 484:
                    case 485:
                    case 486:
                    case 487:
                        return void this._createMiniText(192, 286, _1230114019.SALLY_STRATEGYMAP.getTexture(43), _1230114019.SALLY_STRATEGYMAP.getTexture(44));
                    default:
                        return;
                }
            },
            _1230114023.prototype._createMiniText = function(_2079775989, _2079775990, _2079775991, _2079775992) {
                var _2079775993 = new _2079775994(_2079775991, _2079775992);
                _2079775993['x'] = _2079775989,
                _2079775993['y'] = _2079775990,
                this._mini_text_layer.addChild(_2079775993);
            },
            _1230114023.prototype._cleanMiniText = function() {
                for (var _1213532438 = 0, _1213532439 = this._mini_text_layer.children; _1213532438 < _1213532439.length; _1213532438++) {
                    _1213532439[_1213532438].dispose();
                }
                this._mini_text_layer.removeChildren();
            },
            _1230114023.prototype._getTitleTexture = function(_836833585) {
                switch (_836833585) {
                    case 481:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(38);
                    case 482:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(39);
                    case 483:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(40);
                    case 484:
                        return _1230114019.SALLY_STRATEGYMAP.getTexture(41);
                    case 485:
                        return _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(26);
                    case 486:
                        return _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(27);
                    case 487:
                        return _1230114020.SALLY_STRATEGYMAP_SECOND.getTexture(28);
                    default:
                        return PIXI.Texture.EMPTY;
                }
            },
            _1230114023;
</textarea><br>
        Map: <input type="text" id="mapid" value="48" onchange="update()"> <br>
        <br>
        <button name="Update" onclick="update()">Force update</button><br><br>
        <a id="download">Download</a><br>
        <b>Edges map</b><br>
        <script type="text/javascript">
            var show = {}, locData, canvas, loader, map;
            let SERVER = "203.104.209.71";
 
            window.PIXI.utils.skipHello();
            let app = new PIXI.Application({width: 280, height: 338, transparent: true, forceCanvas: true, preserveDrawingBuffer:true});
            document.body.appendChild(canvas = app.view);
            
            let xOff = 0, yOff = 0, drawPhase = "";

            let getTexture = (loc, id) => {
                let texid = loc.toLowerCase() + '_' + id;
                if(PIXI.TextureCache[texid])
                    return texid;
                switch(drawPhase) {
                    case 'area':
                        return "https://i.imgur.com/QXkeLzo.png";
                    case 'plate':
                        return 'https://i.imgur.com/wU3MZmG.png';
                    case 'title':
                        return 'https://i.imgur.com/s2hHrKl.png';
                    case 'arrow':
                    case 'label':
                        return 'https://i.imgur.com/ESZl1ar.png';
                    case 'minitext':
                        return 'https://i.imgur.com/GJrSTKS.png'
                    case 'map':
                        return 'https://i.imgur.com/eUMcFQV.png';
                    default:
                        return 'https://i.imgur.com/WxF5fiw.png';
                }
            };
            let _plate = {removeChildren: () => 0}
            let _createBG = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                sprite.alpha = 63/64
                bgLayer.addChild(sprite);
            };
            let _cleanArrow = () => 0;
            let _createArrow = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                arrowLayer.addChild(sprite);
            };
            let _cleanArea = () => 0;
            let _createArea = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                areaLayer.addChild(sprite);
            };
            let _createTitle = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff+Math.round(140-sprite.width/2), y+yOff);
                titleLayer.addChild(sprite);
            };
            let _cleanLabel = () => 0;
            let _createLabel = (x,y,id) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                labelLayer.addChild(sprite);
            };
            let _createMiniText = _createLabel
            let _cleanMiniText = () => 0;
            let i = (id, x,y) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                miscLayer.addChild(sprite);
            };
            let _createPlateIcon = (id, x, y) => {
                let frame = PIXI.Texture.fromFrame(id);
                let sprite = new PIXI.Sprite(frame);
                sprite.position.set(x+xOff, y+yOff);
                miscLayer.addChild(sprite);
            };
            let bgLayer, areaLayer, arrowLayer, titleLayer, labelLayer, miscLayer;

            function update(selectedmap = document.getElementById("mapid").value) {
                for (let i = app.stage.children.length - 1; i >= 0; i--) {  app.stage.removeChild(app.stage.children[i]); };
                app.stage.addChild(bgLayer = new PIXI.Container);
                app.stage.addChild(areaLayer = new PIXI.Container);
                app.stage.addChild(arrowLayer = new PIXI.Container);
                app.stage.addChild(titleLayer = new PIXI.Container);
                app.stage.addChild(labelLayer = new PIXI.Container);
                app.stage.addChild(miscLayer = new PIXI.Container);

                map = parseInt(selectedmap.replace('-'))
                let code = document.getElementById("code").value;

                let type = ''
                let currentCode = '\n';
                for(let line of code.split("\n")) {
                    if(line.indexOf('    },') > 0) {
                        console.log(currentCode)
                        console.log(`window.${type}=${currentCode}}`)
                        if(type != '')
                            eval(`window.${type}=${currentCode}}`)
                        type = '';
                        currentCode = '\n';
                    } else if(line.indexOf('prototype') > 0) {
                        console.log("pt", line);
                        for(let posType of ['_getBGTexture', '_getTitleTexture', '_createAreaAnimation', '_createArrowAnimation', '_createLabelAnimation', '_createPlate', '_createMiniTextAnimation'])
                            if(line.indexOf(posType) > 0)
                                type = posType;

                        currentCode = line.split(' = ')[1]+'\n';
                    } else {
                        if(type == '_createPlate') console.log('eeee', line)
                        let rep = line.replace(/\w+.([\w]+)\.getTexture\(/g, "getTexture('$1', ").replace(/this./g, '')+'\n';

                        if(type == '_createPlate')
                            rep = rep.replace(/(void )?[_0-9a-z]+\(getTexture/gi, "_createPlateIcon\(getTexture");
                        if(type == '_createPlate')
                            rep = rep.replace(/return [_0-9a-z]+/gi, "return _createPlateIcon");
                        if(type == '_createPlate') console.log('eeee', rep)
                        currentCode += rep;
                    }
                }

                loader = new PIXI.loaders.Loader;

                loader.add([
                        getPath('sally_strategymap.json'),
                        getPath('sally_strategymap_second.json'),
                       'https://i.imgur.com/wU3MZmG.png', // Unkown ship lock
                       'https://i.imgur.com/QXkeLzo.png', // !
                       'https://i.imgur.com/WxF5fiw.png', // flag
                       'https://i.imgur.com/ESZl1ar.png', // empty
                       'https://i.imgur.com/eUMcFQV.png', // map
                       'https://i.imgur.com/s2hHrKl.png', // title
                       'https://i.imgur.com/GJrSTKS.png'  // minitext
                    ]).load(function() {
                    delete document.getElementById("download").href
                    for(let i = 1; _getBGTexture(map*10+i) != PIXI.Texture.EMPTY; i++)
                        showMap(map*10+i);

                    blobUtil.canvasToBlob(canvas, 'image/png').then(function (blob) {
                        console.log(blob.size)
                        document.getElementById("download").href = blobUtil.createObjectURL(blob);
                    })
                    document.getElementById("download").addEventListener('click', function() {
                        let d = new Date();
                        this.download = `Tag lock ${map}.png`;
                    }, false);

                })
            }
            function getPath(url) {
                return `http://${SERVER}/kcs2/img/sally/${url}`
            }
            function showMap(map) {            
                console.log("Show map")
                console.log(map, _getBGTexture(map))
                xOff = 8+(map%10-1)*300;
                yOff = 8;
                app.view.width = (map%10)*300;
                drawPhase = 'map';
                try { _createBG(0,0,_getBGTexture(map)); } catch (e) { console.error(e) }
                drawPhase = 'arrow';
                try { _createArrowAnimation(map); } catch (e) { console.error(e) }
                drawPhase = 'area';
                try { _createAreaAnimation(map); } catch (e) { console.error(e) }
                drawPhase = 'label';
                try { _createLabelAnimation(map); } catch (e) { console.error(e) }
                drawPhase = 'miniText';
                try { _createMiniTextAnimation(map); } catch (e) { console.error(e) }
                drawPhase = 'plate';
                try { _createPlate(map); } catch (e) { console.error(e) }
                drawPhase = 'title';
                try { _createTitle(0,305,_getTitleTexture(map)); } catch (e) { console.error(e) }

                for(let dir of [[1,0,.5,0], [0,-1,1,.5], [1,0,1,.5], [0,1,.5,0]]) {
                    let text = new PIXI.Text("@FlatIsNice", secretstyle);
                    text.setTransform(xOff + app.stage.width*dir[2], app.stage.height*dir[3], 1, 1, Math.atan2(-dir[1], dir[0]));
                    text.anchor.set(.5,0);
                    text.alpha = 1/64;
                    app.stage.addChild(text);
                }
                
                let text = new PIXI.Text("@FlatIsNice", secretstyle);
                text.x = xOff + 30;
                text.y = 290;
                text.alpha = 1/32;
                app.stage.addChild(text);

                app.render();
            }
            let secretstyle = new PIXI.TextStyle({
              fontFamily: "Arial",
              fontSize: 20,
              fill: "#393",
            });

            update();
        </script>
    </body>
</html>